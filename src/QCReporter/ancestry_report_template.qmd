---
title: "Genomics QC Ancestry Report"
author: "GDC Data Team"
date: today
format:
  pdf:
    self-contained: true
execute:
  echo: false
  warning: false
  error: false
  message: false
  toc: true
editor: visual
params:
  path_to_data: "/home/gdc/shared/GDC_pipeline/results/Needed_files_for_report/SMILES_GDA/Full/"
project:
  output-dir: /home/gdc/shared/GDC_pipeline/results/
---

The following is an automated report describing the quality control (QC) processing of your dataset.

```{r loadPackages}
#| message: false
#| echo: false
.libPaths("/home/gdc/public/Ref/R")
library(dplyr)
library(ggplot2)
library(gt)
library(forcats)
```

# Ancestry predictions

Ancestries are predicted after the initial round of QC steps. The principal components upon which the population is stratifed, are based off of the [genetic relatedness matrix (GRM)](https://zjuwhw.github.io/2021/08/20/GRM.html). The subjects are then projected onto the PC space and assigned ethnicities using k-means clustering based on either a standard genomic dataset (such as though genomes) are by the reported ancestries of the subject in the study. Figure @fig-ancestryPredictions the projection of each subject onto the first few PCs. They are colored by their reported ancestries.

The densities of ancestries based on the reference set are represent by the 10% contour lines of the 2d density plots with the observed populations presented as points over top of the densities shown in @fig-ancestryPredictions.

Because of the granularity in which rfMix calculats predicted ancestry we have lumped information into 5 bins 0-20, 20-40, 40-60, 60-80, and 80-100 % with intervals being left-closed and right-open for this report. To view the detailed ancestry percentages look at the .popu file inside of the 'full' directory.

```{r importdata, echo=FALSE}
path_to_data="PATH"
file_name="NAME"
#Data 
ancestry_prediction <- read.delim(paste0(path_to_data, file_name), header=FALSE)

```

<!-- ## Ancestry distribution -->

```{r datacleaning ancestryprediction}
#| echo: false
ncols_ap=ncol(ancestry_prediction)
colnames(ancestry_prediction)[1:5] = c("FID", "IID", "Ancestry", "Estimate_percent", "Distance") 
ancestry_prediction_core=ancestry_prediction %>%
  select(FID, IID, Ancestry, Estimate_percent, Distance)
```

```{r Ancestry Distribution}
ggplot(data=ancestry_prediction, aes(x=Ancestry, fill = Ancestry))+
  geom_histogram(stat = "count", show.legend = FALSE) + 
  ggtitle("Histogram of Predicted Ancestries") +
  theme_classic()
```

```{r Ancestry Distribution Split}
ancestry_prediction %>%
  mutate(Estimation_bucket = cut(Estimate_percent,
                      breaks = c(0, 20, 40, 60, 80, 100),
                      labels = c("0-20", "20-40", "40-60", "60-80", "80-100"),
                      include.lowest = TRUE,
                      right = FALSE)) %>%
  ggplot(aes(x=Estimation_bucket, fill = Ancestry)) +
  geom_bar(show.legend = F) + 
  facet_wrap(vars(as_factor(Ancestry)), scales = "free_y")+
  ggtitle("Predicted ancestries by estimation percentage") +
  labs(fill = "Ancestry") +
  xlab("Ancestry Estimation Percentage") +
  ylab("Number of Individuals") +
  theme_classic() +
  theme(axis.text.x=element_text(angle=90, vjust = 0.5, hjust=1))
```

## Table displaying Predictions

```{r Ancestry Distribution Split Table}
#| warning: false
#| message: false
ancestry_prediction %>% 
  mutate(Estimation_bucket = cut(Estimate_percent,
                      breaks = c(0, 20, 40, 60, 80, 100),
                      labels = c("0-20", "20-40", "40-60", "60-80", "80-100"),
                      include.lowest = TRUE,
                      right = FALSE)) %>%
  group_by(Ancestry, Estimation_bucket) %>%
  summarise(Count = n()) %>%
  gt(rowname_col = "Estimation", groupname_col = "Ancestry") %>%
  cols_label(
    Estimation_bucket="Estimated %"
  ) %>%
  summary_rows(
    groups = everything(),
    columns = Count,
    fns = list(
      total = "sum" 
    )
  )

```

![Ancestry Prediction PC1 and PC2 Plot](PL1P)

![Ancestry Prediction PC1 and PC3 Plot](PL2P)

![Ancestry Prediction PC2 and PC3 Plot](PL3P)

```{r subj_relatedness_hist}
#| label: fig-SubjRelatedness
#| fig-cap: "Subject relatedness."
#| include: true
#| eval: true
relatedness = read.table(paste0(path_to_data,"kinships.kin0"), header=T)
ggplot(data= relatedness, aes(x=Kinship, fill="blue"))+
  geom_bar(show.legend = F) + 
  xlab("Kinship Coefficient") +
  ggtitle("Relatedness of Individuals") +
  theme_classic() +

 # Vertical lines at reference kinship thresholds
  geom_vline(xintercept = c(0.354, 0.177, 0.088, 0.044, 0), 
             linetype = "dashed", color = "red") +

  # Text labels for each line
  annotate("text", x = 0.354, y = Inf, label = "MZ twin (~0.354)", vjust = -0.5, angle = 90, size = 3) +
  annotate("text", x = 0.177, y = Inf, label = "1st deg (~0.177)", vjust = -0.5, angle = 90, size = 3) +
  annotate("text", x = 0.088, y = Inf, label = "2nd deg (~0.088)", vjust = -0.5, angle = 90, size = 3) +
  annotate("text", x = 0.044, y = Inf, label = "3rd deg (~0.044)", vjust = -0.5, angle = 90, size = 3) +
  annotate("text", x = 0.0, y = Inf, label = "Unrelated (< 0.0)", vjust = -0.5, angle = 90, size = 3)

```